default:
  image: ubuntu_coek:latest

stages:
  - build
  - test
  - pages_plot

compile:
  stage: build
  tags: ["docker"]
  script:
    - source /root/.profile
    - echo "HERE"
    - ./build.sh --python --python-exe $PYTHON_DIR/python
    - echo "HERE"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev-public" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  artifacts:
    paths:
      - _build
    expire_in: 1 hour

unit-tests:
  stage: test
  tags: ["docker"]
  script:
    - source /root/.profile
    - cd _build
    - make test
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev-public" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"

performance-tests:
  stage: test
  tags: ["docker"]
  script:
    - |-
          if [[ $CI_PIPELINE_SOURCE == "merge_request_event" ]]; then
            export BRANCH_NAME=$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
          else
            export BRANCH_NAME=$CI_COMMIT_BRANCH
          fi
    - source /root/.profile
    - cd _build
    - ../test/aml_comparisons/scripts/bench_gurobi.sh
    - tar -czvf perf_archive.tgz /coek_performance_results
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev-public" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  artifacts:
    expose_as: 'performance-trend'
    paths:
      - perf_trend.html
      - perf_archive.tgz
    expire_in: 4 weeks

pages:
  stage: pages_plot
  tags: ["docker"]
  script:
    - mkdir public
    - mv _build/perf_trend.html public/index.html
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "dev-public" && $CI_PIPELINE_SOURCE == "push"
    - if: $CI_PIPELINE_SOURCE == "schedule"
  artifacts:
    paths:
      - public
